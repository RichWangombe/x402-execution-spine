# x402 Execution Spine

`x402 Execution Spine` is a programmable execution and settlement layer for AI agents on Cronos.
It executes multi-step workflows, verifies x402 payment permissions, settles USDC, and writes append-only audit records.

## What it does

1. Receives a workflow instruction over HTTP (`POST /execute`).
2. Verifies payment permission (`verifyPayment` in facilitator mode).
3. Executes deterministic steps with retry support.
4. Settles via x402 (`settlePayment` in facilitator mode).
5. Writes full audit records and idempotency-safe outcomes.

## Core components

- `backend/index.ts`: API entrypoint, idempotency, metrics, testnet guard.
- `backend/orchestrator/execute.ts`: deterministic workflow engine + retries.
- `backend/orchestrator/settlement.ts`: mock + facilitator settlement adapters.
- `backend/audit/ledger.ts`: append-only JSONL audit ledger.
- `backend/orchestrator/idempotency-store.ts`: restart-safe idempotency storage.
- `backend/product/with-x402.ts`: drop-in paid endpoint wrapper for Express handlers.

## Testnet lock and safety

Default behavior is testnet-locked.

- `CRONOS_CHAIN_ID=338` (Cronos testnet)
- `ENFORCE_TESTNET=true`

If `ENFORCE_TESTNET=true` and chainId is not `338`, server startup fails.

## Quickstart (mock)

```bash
npm install
npm run dev
```

In another terminal:

```bash
npm run demo
```

## Live demo (testnet facilitator)

Prereqs:

- testnet wallet funded with TCRO + devUSDCe
- `.env` populated (see keys below)
- Cronos testnet RPC: `https://evm-t3.cronos.org/`
- Cronos testnet explorer: `https://explorer.cronos.org/testnet`

Run in one command:

```bash
npm run run:live
```

Or manually:

```bash
npm run dev
npm run demo:live
```

`scripts/demo-live.ts` prints:

- `402 issued`
- `payment verified`
- `settlement submitted`
- `txHash <...>`

## Proof artifacts

Live runs persist proof artifacts in two places:

- audit ledger (`data/audit.jsonl`) via `permission_verified` and `settlement_submitted`
- proof file (`data/proofs/<workflowId>.json`) generated by `scripts/demo-live.ts`

Proof includes:

- payment requirement JSON
- verify response
- settlement response
- tx hash
- explorer URL

### Proof section template

Use this in submissions after a live run:

```
## Proof
- Workflow ID: <wf-live-...>
- Tx Hash: <0x...>
- Explorer: https://explorer.cronos.org/testnet/tx/<0x...>
- Proof file: data/proofs/<wf-live-...>.json
```

## Drop-in paid endpoint wrapper

Use `withX402` to wrap any Express route with x402 settlement:

```ts
import { withX402 } from "../backend/product/with-x402.js";
```

Example app:

```bash
npm run example:paid
```

Route:

- `POST /paid/research`
- expects `x-payment-header` and `x-payment-requirements` headers
- executes through Spine and returns payment execution metadata

## Metrics

Prometheus-style counters available at:

- `GET /metrics`

Current counters include:

- `x402_requests_total`
- `x402_workflows_completed_total`
- `x402_workflows_failed_total`
- `x402_idempotent_replays_total`
- `x402_request_errors_total`

## Environment keys

`.env.example` contains all defaults:

- `PORT`
- `X402_MODE=mock|facilitator`
- `X402_FACILITATOR_URL`
- `CRONOS_CHAIN_ID`
- `CRONOS_RPC_URL`
- `FACILITATOR_PRIVATE_KEY`
- `FACILITATOR_RECEIVER` (optional, defaults to signer address)
- `FACILITATOR_AMOUNT_BASE_UNITS`
- `AUDIT_LOG_PATH`
- `IDEMPOTENCY_LOG_PATH`
- `ENFORCE_TESTNET=true`
